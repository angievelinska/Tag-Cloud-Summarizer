

Create the SQL statement

Example

Top 10 Viewed Pages of Site `Core.com¿ in last 24 hours

Step 1: Write the SQL statement:

select stats.PAGEID as X_VALUE, stats.EVENTCOUNT as Y0, 
       odim.OBJECTID as OBJECTID 
from PAGEDIMENSION dim, OBJECTDIMENSION odim, PAGEVIEWS_dh stats
WHERE
  stats.SITE = (?SiteID) and
  EVENTINTERVALSTART >= (?LowerBound) and
  EVENTINTERVALSTART < (?UpperBound) and
  dim.ID = stats.PAGEID and dim.PAGEOBJECT = odim.ID
ORDER BY Y0 DESC
LIMIT 10

Explanation of parameters and return values:



Time of execution:  2008-02-08 15:05:19 MET (Berlin, Paris, Rome)
Parameter `?SiteID `: In the example, SiteID is 1, since 1 is the Site Core.com¿s ID in table SITEDIMENSION
Parameter `?Upperbound¿: In the example, this is '2008-02-07 14:00:00.000' [UTC Time]
Parameter `?Lowerbound¿: In the example, this is '2008-02-07 13:00:00.000' [UTC Time]
Result column `X_VALUE¿: Technical Page ID
Result column `OBJECTID: The content bean ID
Result column `Y0¿: Number of event counts per object. Need not be consolidated since the data is pre-consolidated in the Database.

Step 2: Test the SQL statement using a tool like SQLSquirrel

Step 3: Wrap the SQL statement in a content bean type.
Create a content type that allows to position a ¿top viewed pages¿ list layout element on the page.
Create a content bean java class for this document type with a getter method

public List<ContentBean> getTopViews() {  
// executes the SQL statement, fetches
// the ids and creates ContentBeans from them

  jdbcTemplate¿

  createBeansFor(¿)

  CacheUtil.cacheFor(¿)

  return beans;
}


3#


Configure the content bean template in your contentbeans.xml with a jdbc connection to your analytics database.



<bean id=¿contentbeanfactory:TopViewedPages¿ singleton=¿false¿ 
  class ="com.customer.TopViewedPagesImpl">
  <property name=¿jdbcTemplate¿ ref=¿jdbcTemplate¿/>
</bean>
4#
Verify and test your setup.
Finally, configure a data view that makes sure the SQL statement is not executed on every request, but only executed when the ¿cacheFor¿ time dependency has expired.

<dataview appliesTo="com.customer.TopViewedPagesImpl">
  <property name=¿topViews¿/>
</dataview>

You're done.