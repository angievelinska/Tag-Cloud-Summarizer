<div xmlns="http://www.coremedia.com/2003/richtext-1.0" xmlns:xlink="http://www.w3.org/1999/xlink"><p>Sending emails to users is a common use case in nowadays web applications. The Social Software Extension provides an easy mechanism to send emails to users. To send an email you can use the following code snippet:</p><p class="p--codeblock">Map&lt;String, Object&gt; map = new HashMap&lt;String, Object&gt;();<br/>map.put("userName", user.getName());<br/>map.put("greeting", "Hello");<br/>mailService.send(user, "mail", map, Locale.GERMAN);</p><p>In order to finally dispatch the mail the <span class="inlineformat--code">mailService</span> takes the following steps:</p><ol><li>Determine the user's email address.</li><li>Look up a  localized <span class="inlineformat--code">MessageTemplate</span> by the given name. (This will usually be a <span class="inlineformat--code">MailMessageTemplate</span>)</li><li>Create a <span class="inlineformat--code">Message</span> instance from the <span class="inlineformat--code">MessageTemplate</span> and evaluate the template text with the given map.</li><li>Dispatch the <span class="inlineformat--code">Message</span> with the help of a <span class="inlineformat--code">MessageTransport</span>.</li></ol><p>In the first step the user's email address is resolved by consulting <span class="inlineformat--code">AddressMapping</span>. The second will look up a localized <span class="inlineformat--code">MailMessageTemplate</span> which could look like this:</p><p class="p--codeblock">MailMessageTemplate template = new MailMessageTemplate();<br/>template.setSubject("Mail from CoreMedia");<br/>template.setFrom("mail@coremedia.com");<br/>template.setText("$greeting $userName!\n\nYou have mail.");</p><p>In the third step the template's <span class="inlineformat--code">text</span>  property will be evaluated using the passed in map. In the fourth step the <span class="inlineformat--code">MessageTemplate</span>'s <span class="inlineformat--code">createMessage</span> is called. The resulting <span class="inlineformat--code">Message</span> is passed to the <span class="inlineformat--code">mailService</span>'s <span class="inlineformat--code">MessageTransport</span> in the fifth step, which dispatches the message.</p><p class="p--heading-2">Setting up the Mail Service</p><p>An example configuration for the Mail Service can be found in the file <span class="inlineformat--code">config/spring/sse/sse-mail-example.xml</span>.</p><p class="p--codeblock">  &lt;bean id="mailTransport" class="com.coremedia.sseimpl.email.MailTransport"&gt;<br/>    &lt;description&gt;<br/>      The MailTransport. Knows how to deliver Messages.<br/>    &lt;/description&gt;<br/>    &lt;property name="mailSender"&gt;<br/>      &lt;bean class="org.springframework.mail.javamail.JavaMailSenderImpl"&gt;<br/>        &lt;property name="host" value="smtp.coremedia.com"/&gt;<br/>      &lt;/bean&gt;<br/>    &lt;/property&gt;<br/>  &lt;/bean&gt;<br/>  <br/>  &lt;bean id="cmsTemplateFinder" parent="defaultTemplateEvaluator"<br/>   class="com.coremedia.sseimpl.email.CmsMailMessageTemplateFinder"&gt;<br/>    &lt;description&gt;<br/>      A template finder that looks up MessageTemplates from the CMS.<br/>      The provided basePath has to point to a CMS folder.<br/>    &lt;/description&gt;<br/>    &lt;property name="basePath" value="/Mail"/&gt;<br/>    &lt;property name="capConnection" ref="capConnection"/&gt;<br/>  &lt;/bean&gt;<br/><br/>  &lt;bean id="resourceBundleTemplateFinder" parent="defaultTemplateEvaluator"<br/>   class="com.coremedia.sseimpl.email.MessageSourceMailTemplateFinder"&gt;<br/>    &lt;description&gt;<br/>      A template finder that looks up MessageTemplates from a given ResourceBundle.<br/>      You may add your own MessageSource.<br/>    &lt;/description&gt;<br/>    &lt;property name="messageSource"&gt;<br/>      &lt;bean class="org.springframework.context.support.ResourceBundleMessageSource"&gt;<br/>        &lt;property name="basenames"&gt;<br/>          &lt;description&gt;<br/>            A list of ResourceBundles to search for messages.<br/>            Be aware that the search order is important:<br/>            First come wins.<br/>          &lt;/description&gt;<br/>          &lt;list&gt;<br/>            &lt;value&gt;com.coremedia.sse.example.Mail&lt;/value&gt;<br/>          &lt;/list&gt;<br/>        &lt;/property&gt;<br/>      &lt;/bean&gt;<br/>    &lt;/property&gt;<br/>  &lt;/bean&gt;<br/><br/>  &lt;bean id="mailService" class="com.coremedia.sse.messaging.DefaultMessageService"&gt;<br/>    &lt;description&gt;<br/>      The Mail Service bean.<br/>    &lt;/description&gt;<br/>    &lt;property name="messageTransport" ref="mailTransport"&gt;<br/>    &lt;/property&gt;<br/>    &lt;property name="addressMapping"&gt;<br/>      &lt;description&gt;<br/>        Determines from where a User's email address should be retrieved.<br/>      &lt;/description&gt;<br/>      &lt;bean class="com.coremedia.sse.messaging.DefaultAddressMapping"&gt;<br/>        &lt;property name="baseModule" ref="baseModule"/&gt;<br/>      &lt;/bean&gt;<br/>    &lt;/property&gt;<br/>    &lt;property name="templateFinder" ref="cmsTemplateFinder"/&gt;<br/>  &lt;/bean&gt;<br/><br/>  &lt;bean id="defaultTemplateEvaluator" abstract="true"&gt;<br/>    &lt;property name="templateEvaluator" ref="templateEvaluator"/&gt;<br/>  &lt;/bean&gt;<br/><br/>  &lt;bean id="templateEvaluator" class="com.coremedia.sseimpl.util.VelocityTemplateEvaluator"&gt;<br/>    &lt;description&gt;<br/>      The default evaluator for MessageTemplates. Is responsible for rendering the message body.<br/>      Velocity is used as the templating language.<br/>    &lt;/description&gt;<br/>    &lt;property name="velocityEngine" ref="velocityEngine"/&gt;<br/>  &lt;/bean&gt; <br/><br/>  &lt;bean id="velocityEngine" class="org.springframework.ui.velocity.VelocityEngineFactoryBean"/&gt;<br/>  <br/>&lt;/beans&gt;</p><p>In order to get up on your feet quickly you need to do two things. Tell the Mail Service where to find a user's email address and where to find the mail templates.</p><p class="p--heading-2">Step 1: Retrieving a user's address</p><p>You may use the interface <span class="inlineformat--code">AddressMapping</span> to determine a user's address.<br/>The default implementation <span class="inlineformat--code">AddressMappingImpl</span> will look up the <span class="inlineformat--code">emailAddress</span> property on the user's <span class="inlineformat--code">VCard</span>. You can configure which property to look up on which <span class="inlineformat--code">ProfileCard</span>.</p><p class="p--codeblock">&lt;bean id="addressMapping" class="com.coremedia.sse.messaging.DefaultAddressMapping"&gt;<br/>  &lt;description&gt;<br/>    The AddressMapping is responsible for mapping User's to addresses and vice versa.<br/>    The properties below show the default configuration. If you're fine with these you can<br/>    use the DefaultAddressMapping unconfigured. <br/>  &lt;/description&gt; <br/>  &lt;property name="baseModule" ref="baseModule"/&gt;<br/>  &lt;property name="propertyName" value="emailAddress"/&gt;<br/>  &lt;property name="profileCardType"&gt;<br/>    &lt;util:property-path path="baseModule.vCardType"/&gt;<br/>  &lt;/property&gt;<br/>&lt;/bean&gt;</p><p>To customize the <span class="inlineformat--code">DefaultAddressMapping</span> use a different <span class="inlineformat--code">propertyName</span> and <span class="inlineformat--code">profileCardType</span>.</p><p class="p--heading-2">Step 2: Finding a message template</p><p>You can either store your mail templates in <span class="inlineformat--code">ResourceBundle</span> and access them via <span class="inlineformat--code">MessageSourceMailTemplateFinder</span> or retrieve them via an UAPI connection by using the <span class="inlineformat--code">CmsMailMessageTemplateFinder</span>.<br/>In both cases you have to adhere to a naming scheme. Mail templates are looked up by name. In the former variant the template name corresponds to a message key. When using the latter variant the template name must match a CMS Content name.</p><p><br/>When using the ResourceBundle variant you should define some property files like this:</p><p class="p--codeblock">#mail.properties<br/>mail.subject=Hello!<br/>mail.from=mail@example.coremedia.com<br/>mail.text=$greeting $userName \nI'm sending some mail. I can even use Velocity templates if I like to. </p><p class="p--codeblock">#mail_de.properties<br/>mail.subject=Hallo!<br/>mail.from=mail@example.coremedia.com<br/>mail.text=$greeting $userName \nIch versende eine Mail. I kann sogar Velocity-Templates benutzen.</p><p>Now when you look up the mail template named "mail" the TemplateFinder will look through the ResourceBundles and retrieve a localized<br/>version of your mail template.</p><p>Storing mail templates in the CMS works in a similar fashion. Decide on a path where to store your templates, i.e. "/Mail".<br/>Now create various documents like "mail", "mail_de", "mail_fr". The documents should be of the following type:</p><p class="p--codeblock">  &lt;DocType Name="Mail"&gt;<br/>    &lt;StringProperty Name="subject" Length="128" /&gt;<br/>    &lt;StringProperty Name="from" Length="128" /&gt;<br/>    &lt;BlobProperty Name="text" MimeType="text/plain"/&gt;    <br/>  &lt;/DocType&gt;</p><p class="p--heading-2">Step 3: Creating the Message instance</p><p>The <span class="inlineformat--code">mailService</span> passes the address found by consulting the <span class="inlineformat--code">AddressMapping</span> and the map to the <span class="inlineformat--code">MessageTemplate</span> once it has been found. The <span class="inlineformat--code">TemplateFinder</span> also sets a <span class="inlineformat--code">TemplateEvaluator</span> on the <span class="inlineformat--code">MessageTemplate</span> to be used for evaluating the text body of the <span class="inlineformat--code">Message</span>.</p><p class="p--codeblock">MailMessageTemplate template = new MailMessageTemplate();<br/>Map map = new HashMap();<br/>map.put("userName", user.getName());<br/>map.put("greeting", "Hello");<br/>Message msg = template.createMessage("lisa@simpsons.com", map);</p><p>In the examples above both template finders are configured with a default <span class="inlineformat--code">TemplateEvaluator</span>. A TemplateEvaluator is responsible for evaluating the variables in the MessageTemplate's text property and return the rendered string. Usually you would want to pass variables like userName, date, url or other aspects that need to be set dynamically to the <span class="inlineformat--code">MessageTemplate</span>. The default evaluator supplied with the Social Software Extension is the <span class="inlineformat--code">VelocityTemplateEvaluator</span> which uses the powerful Velocity templating engine. If you would like to use a different templating engine or create your own, implement the <span class="inlineformat--code">TemplateEvaluator</span> interface. It's up to you if you even want to use a TemplateEvaluator or rather implement the evaluation logic in your <span class="inlineformat--code">MessageTemplate</span> implementation. The <span class="inlineformat--code">TemplateEvaluator</span> interface is only provided for convenience. When using the upper configuration for instance <span class="inlineformat--code">msg.getText()</span> would be:</p><p class="p--codeblock">Hello Lisa!<br/>I'm sending some mail. I can even use Velocity templates if I like to.</p><p class="p--heading-2">Step 4: Dispatching the Message</p><p>Once your Message instance has been created, the mailService passes it to it's messageTransport. The sole responsibility of a MessageTransport is to send out the message. It knows about a <span class="inlineformat--code">Message's</span> protocol. In case of an email the MessageTransport would open an SMTP connection etc. Your own implementation could send out <span class="inlineformat--code">Messages</span> via SMS or relay them to one of the many social networks. </p><p/></div><div xmlns="http://www.coremedia.com/2003/richtext-1.0" xmlns:xlink="http://www.w3.org/1999/xlink"><p>Sending mail is easy peasy like one two three.</p></div>